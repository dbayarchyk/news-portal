version: 2.1
orbs:
  docker: circleci/docker@1.2.1
jobs:
  # Market service jobs:
  build-market-service-docker-image:
    machine: true
    steps:
      - checkout
      - run: docker build -t dbayarchyk/itdog-market-service -f ~/project/api/services/market/Dockerfile ~/project/api/services/market
      - run: docker save -o ~/project/persisted-market-service-image dbayarchyk/itdog-market-service
      - persist_to_workspace:
          root: ~/project
          # Must be relative path from root
          paths:
            - ./persisted-market-service-image
  lint-market-service:
    machine: true
    steps:
      - attach_workspace:
          at: ~/project
      - run: docker load -i ~/project/persisted-market-service-image
      - run: docker run -t dbayarchyk/itdog-market-service npm run lint
  test-market-service:
    machine: true
    steps:
      - attach_workspace:
          at: ~/project
      - run: docker load -i ~/project/persisted-market-service-image
      - run: docker run -e CI=true -t dbayarchyk/itdog-market-service npm run test
  push-market-service-docker-image:
    machine: true
    steps:
      - attach_workspace:
          at: ~/project
      - run: docker load -i ~/project/persisted-market-service-image
      - run: docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
      - run: docker push dbayarchyk/itdog-market-service

  # Comment service jobs:
  build-comment-service-docker-image:
    machine: true
    steps:
      - checkout
      - run: docker build -t dbayarchyk/itdog-comment-service -f ~/project/api/services/comment/Dockerfile ~/project/api/services/comment
      - run: docker save -o ~/project/persisted-comment-service-image dbayarchyk/itdog-comment-service
      - persist_to_workspace:
          root: ~/project
          # Must be relative path from root
          paths:
            - ./persisted-comment-service-image
  lint-comment-service:
    machine: true
    steps:
      - attach_workspace:
          at: ~/project
      - run: docker load -i ~/project/persisted-comment-service-image
      - run: docker run -t dbayarchyk/itdog-comment-service npm run lint
  test-comment-service:
    machine: true
    steps:
      - attach_workspace:
          at: ~/project
      - run: docker load -i ~/project/persisted-comment-service-image
      - run: docker run -e CI=true -t dbayarchyk/itdog-comment-service npm run test
  push-comment-service-docker-image:
    machine: true
    steps:
      - attach_workspace:
          at: ~/project
      - run: docker load -i ~/project/persisted-comment-service-image
      - run: docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
      - run: docker push dbayarchyk/itdog-comment-service

  # Web jobs:
  build-web-docker-image:
    machine: true
    steps:
      - checkout
      - run: docker build -t dbayarchyk/itdog-web -f ~/project/web/Dockerfile --build-arg CONTENTFUL_SPACE_ID_ARG=$CONTENTFUL_SPACE_ID --build-arg CONTENTFUL_ACCESS_TOKEN_ARG=$CONTENTFUL_ACCESS_TOKEN ~/project/web
      - run: docker save -o ~/project/persisted-web-image dbayarchyk/itdog-web
      - persist_to_workspace:
          root: ~/project
          # Must be relative path from root
          paths:
            - ./persisted-web-image
  lint-web:
    machine: true
    steps:
      - attach_workspace:
          at: ~/project
      - run: docker load -i ~/project/persisted-web-image
      - run: docker run -t dbayarchyk/itdog-web npm run lint
  test-web:
    machine: true
    steps:
      - attach_workspace:
          at: ~/project
      - run: docker load -i ~/project/persisted-web-image
      - run: docker run -e CI=true -t dbayarchyk/itdog-web npm run test
  push-web-docker-image:
    machine: true
    steps:
      - attach_workspace:
          at: ~/project
      - run: docker load -i ~/project/persisted-web-image
      - run: docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
      - run: docker push dbayarchyk/itdog-web
workflows:
  build-and-publish-docker-images:
    jobs:
      - build-market-service-docker-image
      - build-comment-service-docker-image
      - build-web-docker-image

      - lint-market-service:
          requires:
            - build-market-service-docker-image
      - lint-comment-service:
          requires:
            - build-comment-service-docker-image
      - lint-web:
          requires:
            - build-web-docker-image

      - test-market-service:
          requires:
            - build-market-service-docker-image
      - test-comment-service:
          requires:
            - build-comment-service-docker-image
      - test-web:
          requires:
            - build-web-docker-image

      - push-market-service-docker-image:
          requires:
            - lint-market-service
            - test-market-service
          filters:
            branches:
              only:
                - master
      - push-comment-service-docker-image:
          requires:
            - lint-comment-service
            - test-comment-service
          filters:
            branches:
              only:
                - master
      - push-web-docker-image:
          requires:
            - lint-web
            - test-web
          filters:
            branches:
              only:
                - master
